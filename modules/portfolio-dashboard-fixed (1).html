<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Management System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
:root{--primary:#2563eb;--secondary:#64748b;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--dark:#1e293b}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#f1f5f9}
.main-container{max-width:1400px;margin:0 auto;padding:20px}
.module-header{background:linear-gradient(135deg,var(--primary),#1e40af);color:white;padding:20px;border-radius:12px 12px 0 0;margin-bottom:0}
.module-body{background:white;padding:20px;border-radius:0 0 12px 12px;box-shadow:0 4px 6px rgba(0,0,0,0.07)}
.nav-tabs{border-bottom:2px solid #e2e8f0}
.nav-tabs .nav-link{color:var(--secondary);border:none;padding:12px 24px;font-weight:500}
.nav-tabs .nav-link.active{color:var(--primary);border-bottom:3px solid var(--primary);background:transparent}
.filter-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;margin-bottom:20px}
.stat-card{background:white;border:1px solid #e2e8f0;border-radius:8px;padding:20px;text-align:center;transition:all 0.3s}
.stat-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateY(-2px)}
.stat-value{font-size:2rem;font-weight:700;color:var(--primary)}
.stat-label{color:var(--secondary);font-size:0.875rem;margin-top:5px}
.data-table{border-radius:8px;overflow:hidden}
.table thead th{background:#f8fafc;border-bottom:2px solid #e2e8f0;font-weight:600;color:var(--dark)}
.description-text{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chart-container{background:white;border:1px solid #e2e8f0;border-radius:8px;padding:20px;margin-bottom:20px;min-height:300px}
.export-menu{position:absolute;right:20px;top:20px}
.module-selector{display:flex;gap:10px;margin-bottom:20px}
.module-btn{padding:8px 16px;border:2px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;transition:all 0.3s}
.module-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
.er-diagram{background:#f8fafc;padding:20px;border-radius:8px;font-family:monospace;white-space:pre}
@media print{.no-print{display:none!important}}
</style>
</head>
<body>
<div class="main-container">
<div class="module-header">
<div class="d-flex justify-content-between align-items-center">
<div>
<h1 class="h3 mb-0">Portfolio Management System</h1>
<small>Modular Business Intelligence Dashboard</small>
</div>
<div class="export-menu no-print">
<div class="dropdown">
<button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">Export Data</button>
<ul class="dropdown-menu">
<li><a class="dropdown-item" href="#" onclick="exportModule.exportExcel()">Excel (.xlsx)</a></li>
<li><a class="dropdown-item" href="#" onclick="exportModule.exportPDF()">PDF Report</a></li>
<li><a class="dropdown-item" href="#" onclick="exportModule.exportJSON()">JSON</a></li>
<li><a class="dropdown-item" href="#" onclick="exportModule.exportSQL()">SQL</a></li>
</ul>
</div>
</div>
</div>
</div>
<div class="module-body">
<ul class="nav nav-tabs mb-4 no-print" role="tablist">
<li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dashboard">Dashboard</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#analytics">Analytics</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reports">Reports</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#database">Database Design</a></li>
<li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#data">Data Management</a></li>
</ul>
<div class="tab-content">
<div class="tab-pane fade show active" id="dashboard">
<div class="filter-card no-print">
<div class="row g-3">
<div class="col-md-2">
<input type="text" class="form-control" id="searchPO" placeholder="PO Number">
</div>
<div class="col-md-2">
<input type="text" class="form-control" id="searchClient" placeholder="Client Name">
</div>
<div class="col-md-2">
<select class="form-select" id="filterProject">
<option value="">All Projects</option>
</select>
</div>
<div class="col-md-2">
<input type="date" class="form-control" id="dateFrom">
</div>
<div class="col-md-2">
<input type="date" class="form-control" id="dateTo">
</div>
<div class="col-md-2">
<button class="btn btn-primary w-100" onclick="dataModule.applyFilters()">Search</button>
</div>
</div>
<div class="row mt-2">
<div class="col-md-2">
<input type="number" class="form-control" id="minAmount" placeholder="Min Amount">
</div>
<div class="col-md-2">
<input type="number" class="form-control" id="maxAmount" placeholder="Max Amount">
</div>
<div class="col-md-2">
<select class="form-select" id="filterStatus">
<option value="">All Status</option>
<option value="active">Active</option>
<option value="completed">Completed</option>
<option value="cancelled">Cancelled</option>
</select>
</div>
<div class="col-md-4">
<input type="text" class="form-control" id="searchDescription" placeholder="Search in Description">
</div>
<div class="col-md-2">
<button class="btn btn-secondary w-100" onclick="dataModule.clearFilters()">Clear</button>
</div>
</div>
</div>
<div class="row mb-4">
<div class="col-md-3">
<div class="stat-card">
<div class="stat-value" id="totalPO">0</div>
<div class="stat-label">Total PO</div>
</div>
</div>
<div class="col-md-3">
<div class="stat-card">
<div class="stat-value" id="totalAmount">฿0</div>
<div class="stat-label">Total Amount (THB)</div>
</div>
</div>
<div class="col-md-3">
<div class="stat-card">
<div class="stat-value" id="totalProjects">0</div>
<div class="stat-label">Active Projects</div>
</div>
</div>
<div class="col-md-3">
<div class="stat-card">
<div class="stat-value" id="avgAmount">฿0</div>
<div class="stat-label">Average PO Value</div>
</div>
</div>
</div>
<div class="data-table">
<table class="table table-hover" id="dataTable">
<thead>
<tr>
<th>PO Number</th>
<th>Date</th>
<th>Client</th>
<th>Project</th>
<th>Description</th>
<th>Amount (THB)</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>
<div class="tab-pane fade" id="analytics">
<div class="row">
<div class="col-md-6">
<div class="chart-container">
<canvas id="projectChart"></canvas>
</div>
</div>
<div class="col-md-6">
<div class="chart-container">
<canvas id="monthlyChart"></canvas>
</div>
</div>
</div>
<div class="row mt-3">
<div class="col-md-12">
<div class="chart-container">
<canvas id="trendChart"></canvas>
</div>
</div>
</div>
</div>
<div class="tab-pane fade" id="reports">
<div class="module-selector no-print">
<button class="module-btn active" onclick="reportModule.showReport('summary')">Summary Report</button>
<button class="module-btn" onclick="reportModule.showReport('detail')">Detail Report</button>
<button class="module-btn" onclick="reportModule.showReport('a4')">A4 Print Report</button>
</div>
<div id="reportContainer"></div>
</div>
<div class="tab-pane fade" id="database">
<h5>Entity Relationship Diagram</h5>
<div class="er-diagram">
┌─────────────────────────┐     ┌─────────────────────────┐     ┌─────────────────────────┐
│      PORTFOLIOS         │     │        CLIENTS          │     │       PROJECTS          │
├─────────────────────────┤     ├─────────────────────────┤     ├─────────────────────────┤
│ • id (PK)               │     │ • id (PK)               │     │ • id (PK)               │
│ • po_number (UNIQUE)    │     │ • client_code (UNIQUE)  │     │ • project_code (UNIQUE) │
│ • issue_date            │────►│ • company_name          │◄────│ • project_name          │
│ • client_id (FK)        │     │ • contact_person        │     │ • client_id (FK)        │
│ • project_id (FK)       │     │ • phone                 │     │ • start_date            │
│ • description           │     │ • email                 │     │ • end_date              │
│ • total_amount          │     │ • address               │     │ • budget                │
│ • status                │     │ • tax_id                │     │ • status                │
│ • created_at            │     │ • created_at            │     │ • manager               │
│ • updated_at            │     └─────────────────────────┘     └─────────────────────────┘
└─────────────────────────┘                  │                              │
           │                                  │                              │
           ▼                                  ▼                              ▼
┌─────────────────────────┐     ┌─────────────────────────┐     ┌─────────────────────────┐
│      PORTFOLIO_ITEMS    │     │      TRANSACTIONS       │     │      ATTACHMENTS        │
├─────────────────────────┤     ├─────────────────────────┤     ├─────────────────────────┤
│ • id (PK)               │     │ • id (PK)               │     │ • id (PK)               │
│ • portfolio_id (FK)     │     │ • portfolio_id (FK)     │     │ • portfolio_id (FK)     │
│ • item_description      │     │ • transaction_date      │     │ • file_name             │
│ • quantity              │     │ • type (income/expense) │     │ • file_type             │
│ • unit_price            │     │ • amount                │     │ • file_path             │
│ • total_price           │     │ • reference_no          │     │ • uploaded_at           │
└─────────────────────────┘     └─────────────────────────┘     └─────────────────────────┘

Relationships:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. PORTFOLIOS ──many-to-1──► CLIENTS (One client can have many portfolios)
2. PORTFOLIOS ──many-to-1──► PROJECTS (One project can have many portfolios)
3. PROJECTS ──many-to-1──► CLIENTS (One client can have many projects)
4. PORTFOLIO_ITEMS ──many-to-1──► PORTFOLIOS (One portfolio has many items)
5. TRANSACTIONS ──many-to-1──► PORTFOLIOS (One portfolio has many transactions)
6. ATTACHMENTS ──many-to-1──► PORTFOLIOS (One portfolio has many attachments)
</div>
</div>
<div class="tab-pane fade" id="data">
<div class="row">
<div class="col-md-6">
<div class="card">
<div class="card-header">Import Data</div>
<div class="card-body">
<input type="file" class="form-control mb-3" id="importFile" accept=".csv,.json,.xlsx">
<button class="btn btn-success" onclick="dataModule.importData()">Import</button>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card">
<div class="card-header">Data Operations</div>
<div class="card-body">
<button class="btn btn-warning mb-2 w-100" onclick="dataModule.backup()">Backup Database</button>
<button class="btn btn-info mb-2 w-100" onclick="dataModule.sync()">Sync with Server</button>
<button class="btn btn-danger w-100" onclick="dataModule.clearCache()">Clear Cache</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script>
const dataModule = {
  data: [
    {po_number:'OB130278',issue_date:'2008-09-05',client_name:'PTT Exploration and Production',project:'Bangkok Project',description:'Network infrastructure upgrade with redundant systems',total_amount:1070000,status:'completed'},
    {po_number:'OB126282',issue_date:'2008-08-28',client_name:'PTT Exploration and Production',project:'Bangkok Project',description:'Wireless broadband access implementation',total_amount:110000,status:'completed'},
    {po_number:'OB133728',issue_date:'2009-03-19',client_name:'PTT Exploration and Production',project:'Bangkok Project',description:'Complete wireless solution with antenna systems',total_amount:458000,status:'completed'},
    {po_number:'OA119706',issue_date:'2010-04-06',client_name:'PTT Exploration and Production',project:'Arthit Project',description:'Base station deployment with training services',total_amount:510000,status:'active'},
    {po_number:'OA120001',issue_date:'2024-01-15',client_name:'Thai Oil Public Company',project:'Rayong Project',description:'Refinery control system upgrade',total_amount:750000,status:'active'},
    {po_number:'OA120002',issue_date:'2024-02-20',client_name:'PTTGC',project:'Polymer Project',description:'Laboratory equipment installation',total_amount:320000,status:'active'},
    {po_number:'OA120003',issue_date:'2024-03-10',client_name:'SCG Chemicals',project:'Expansion Project',description:'Plant automation system',total_amount:890000,status:'active'},
    {po_number:'OA120004',issue_date:'2024-04-05',client_name:'IRPC',project:'Refinery Upgrade',description:'Safety system implementation',total_amount:455000,status:'active'},
    {po_number:'OA120005',issue_date:'2024-05-12',client_name:'Bangchak Corporation',project:'Solar Farm Project',description:'Solar panel monitoring system',total_amount:1250000,status:'active'}
  ],
  filteredData: [],
  dataTable: null,
  
  init() {
    this.filteredData = [...this.data];
    this.loadFromStorage();
    this.populateFilters();
    this.render();
    this.initCharts();
    this.initDataTable();
  },
  
  loadFromStorage() {
    const saved = localStorage.getItem('portfolioData');
    if(saved) {
      try {
        this.data = JSON.parse(saved);
        this.filteredData = [...this.data];
      } catch(e) {}
    }
  },
  
  saveToStorage() {
    localStorage.setItem('portfolioData', JSON.stringify(this.data));
  },
  
  populateFilters() {
    const projects = [...new Set(this.data.map(d => d.project))];
    const select = document.getElementById('filterProject');
    select.innerHTML = '<option value="">All Projects</option>' + 
                       projects.map(p => `<option value="${p}">${p}</option>`).join('');
  },
  
  applyFilters() {
    const po = document.getElementById('searchPO').value.toLowerCase();
    const client = document.getElementById('searchClient').value.toLowerCase();
    const project = document.getElementById('filterProject').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
    const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
    const status = document.getElementById('filterStatus').value;
    const description = document.getElementById('searchDescription').value.toLowerCase();
    
    this.filteredData = this.data.filter(item => {
      const matchPO = !po || item.po_number.toLowerCase().includes(po);
      const matchClient = !client || item.client_name.toLowerCase().includes(client);
      const matchProject = !project || item.project === project;
      const matchDateFrom = !dateFrom || item.issue_date >= dateFrom;
      const matchDateTo = !dateTo || item.issue_date <= dateTo;
      const matchMinAmount = item.total_amount >= minAmount;
      const matchMaxAmount = item.total_amount <= maxAmount;
      const matchStatus = !status || item.status === status;
      const matchDescription = !description || item.description.toLowerCase().includes(description);
      
      return matchPO && matchClient && matchProject && matchDateFrom && matchDateTo && 
             matchMinAmount && matchMaxAmount && matchStatus && matchDescription;
    });
    
    this.render();
  },
  
  clearFilters() {
    document.getElementById('searchPO').value = '';
    document.getElementById('searchClient').value = '';
    document.getElementById('filterProject').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('minAmount').value = '';
    document.getElementById('maxAmount').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchDescription').value = '';
    this.filteredData = [...this.data];
    this.render();
  },
  
  render() {
    this.updateStats();
    this.renderTable();
    if(this.charts) this.updateCharts();
  },
  
  updateStats() {
    const total = this.filteredData.length;
    const amount = this.filteredData.reduce((sum, d) => sum + d.total_amount, 0);
    const projects = new Set(this.filteredData.map(d => d.project)).size;
    const avg = total > 0 ? amount / total : 0;
    
    document.getElementById('totalPO').textContent = total;
    document.getElementById('totalAmount').textContent = '฿' + amount.toLocaleString('th-TH');
    document.getElementById('totalProjects').textContent = projects;
    document.getElementById('avgAmount').textContent = '฿' + avg.toLocaleString('th-TH', {maximumFractionDigits:0});
  },
  
  renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = this.filteredData.map(item => `
      <tr>
        <td><strong>${item.po_number}</strong></td>
        <td>${new Date(item.issue_date).toLocaleDateString('en-US')}</td>
        <td>${item.client_name}</td>
        <td><span class="badge bg-primary">${item.project}</span></td>
        <td><div class="description-text" title="${item.description}">${item.description}</div></td>
        <td class="text-end"><strong>฿${item.total_amount.toLocaleString('th-TH')}</strong></td>
        <td><span class="badge bg-${item.status === 'active' ? 'success' : item.status === 'completed' ? 'secondary' : 'danger'}">${item.status}</span></td>
      </tr>
    `).join('');
    
    if(this.dataTable) {
      this.dataTable.clear().destroy();
    }
    this.initDataTable();
  },
  
  initDataTable() {
    if($.fn.DataTable) {
      this.dataTable = $('#dataTable').DataTable({
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
        searching: false,
        ordering: true,
        info: true,
        paging: true
      });
    }
  },
  
  initCharts() {
    this.charts = true;
    const ctx1 = document.getElementById('projectChart');
    const ctx2 = document.getElementById('monthlyChart');
    const ctx3 = document.getElementById('trendChart');
    
    if(ctx1 && ctx2 && ctx3) {
      this.projectChart = new Chart(ctx1, {
        type: 'pie',
        data: {labels:[], datasets:[{data:[],backgroundColor:['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4']}]},
        options: {responsive:true, plugins:{title:{display:true,text:'Projects Distribution'}}}
      });
      
      this.monthlyChart = new Chart(ctx2, {
        type: 'bar',
        data: {labels:[], datasets:[{label:'Monthly Amount',data:[],backgroundColor:'#2563eb'}]},
        options: {responsive:true, plugins:{title:{display:true,text:'Monthly Performance'}}}
      });
      
      this.trendChart = new Chart(ctx3, {
        type: 'line',
        data: {labels:[], datasets:[{label:'Amount Trend',data:[],borderColor:'#10b981',tension:0.4,fill:false}]},
        options: {responsive:true, plugins:{title:{display:true,text:'Amount Trend Analysis'}}}
      });
      
      this.updateCharts();
    }
  },
  
  updateCharts() {
    if(!this.charts) return;
    
    const projectData = {};
    this.filteredData.forEach(d => {
      projectData[d.project] = (projectData[d.project] || 0) + d.total_amount;
    });
    
    this.projectChart.data.labels = Object.keys(projectData);
    this.projectChart.data.datasets[0].data = Object.values(projectData);
    this.projectChart.update();
    
    const monthlyData = {};
    this.filteredData.forEach(d => {
      const month = d.issue_date.substring(0,7);
      monthlyData[month] = (monthlyData[month] || 0) + d.total_amount;
    });
    
    this.monthlyChart.data.labels = Object.keys(monthlyData);
    this.monthlyChart.data.datasets[0].data = Object.values(monthlyData);
    this.monthlyChart.update();
    
    const sortedData = [...this.filteredData].sort((a,b) => a.issue_date.localeCompare(b.issue_date));
    this.trendChart.data.labels = sortedData.map(d => d.po_number);
    this.trendChart.data.datasets[0].data = sortedData.map(d => d.total_amount);
    this.trendChart.update();
  },
  
  importData() {
    const file = document.getElementById('importFile').files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        if(file.name.endsWith('.json')) {
          const imported = JSON.parse(e.target.result);
          this.data = Array.isArray(imported) ? imported : [imported];
        } else if(file.name.endsWith('.csv')) {
          const lines = e.target.result.split('\n');
          const headers = lines[0].split(',');
          const imported = [];
          for(let i = 1; i < lines.length; i++) {
            if(lines[i].trim()) {
              const values = lines[i].split(',');
              const obj = {};
              headers.forEach((h,idx) => {
                obj[h.trim()] = values[idx]?.trim();
              });
              imported.push(obj);
            }
          }
          this.data = [...this.data, ...imported];
        }
        
        this.filteredData = [...this.data];
        this.saveToStorage();
        this.populateFilters();
        this.render();
        alert('Import successful!');
      } catch(err) {
        alert('Import failed: ' + err.message);
      }
    };
    reader.readAsText(file);
  },
  
  backup() {
    const backup = {
      version: '2.0',
      timestamp: new Date().toISOString(),
      data: this.data
    };
    const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup_${Date.now()}.json`;
    a.click();
  },
  
  sync() {
    alert('Syncing with server...\nThis would connect to your backend API.');
  },
  
  clearCache() {
    if(confirm('Clear all cached data? This cannot be undone.')) {
      localStorage.clear();
      location.reload();
    }
  }
};

const exportModule = {
  exportExcel() {
    if(typeof XLSX === 'undefined') {
      alert('Excel export library not loaded');
      return;
    }
    const ws = XLSX.utils.json_to_sheet(dataModule.filteredData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Portfolio');
    XLSX.writeFile(wb, 'portfolio.xlsx');
  },
  
  exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('Portfolio Report', 14, 20);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString('en-US')}`, 14, 28);
    
    const headers = [['PO Number', 'Date', 'Client', 'Project', 'Amount']];
    const data = dataModule.filteredData.map(d => [
      d.po_number,
      new Date(d.issue_date).toLocaleDateString('en-US'),
      d.client_name,
      d.project,
      '฿' + d.total_amount.toLocaleString()
    ]);
    
    doc.autoTable({
      head: headers,
      body: data,
      startY: 35
    });
    
    doc.save('portfolio_report.pdf');
  },
  
  exportJSON() {
    const blob = new Blob([JSON.stringify(dataModule.filteredData, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'portfolio.json';
    a.click();
  },
  
  exportSQL() {
    let sql = '-- Portfolio Export\n';
    sql += '-- Generated: ' + new Date().toISOString() + '\n\n';
    sql += 'INSERT INTO portfolios (po_number, issue_date, total_amount, client_name, project, description, status) VALUES\n';
    sql += dataModule.filteredData.map(d => 
      `('${d.po_number}', '${d.issue_date}', ${d.total_amount}, '${d.client_name}', '${d.project}', '${d.description}', '${d.status}')`
    ).join(',\n') + ';';
    
    const blob = new Blob([sql], {type:'text/sql'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'portfolio.sql';
    a.click();
  }
};

const reportModule = {
  showReport(type) {
    const container = document.getElementById('reportContainer');
    document.querySelectorAll('.module-btn').forEach(b => b.classList.remove('active'));
    if(event && event.target) event.target.classList.add('active');
    
    if(type === 'summary') {
      container.innerHTML = this.generateSummary();
    } else if(type === 'detail') {
      container.innerHTML = this.generateDetail();
    } else if(type === 'a4') {
      container.innerHTML = this.generateA4();
    }
  },
  
  generateSummary() {
    const total = dataModule.filteredData.reduce((sum, d) => sum + d.total_amount, 0);
    const projects = [...new Set(dataModule.filteredData.map(d => d.project))];
    const clients = [...new Set(dataModule.filteredData.map(d => d.client_name))];
    
    return `
      <div class="card">
        <div class="card-body">
          <h5>Executive Summary Report</h5>
          <hr>
          <div class="row">
            <div class="col-md-6">
              <p><strong>Total Portfolio Value:</strong> ฿${total.toLocaleString('th-TH')}</p>
              <p><strong>Number of POs:</strong> ${dataModule.filteredData.length}</p>
              <p><strong>Average PO Value:</strong> ฿${(total/dataModule.filteredData.length).toLocaleString('th-TH', {maximumFractionDigits:0})}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Number of Projects:</strong> ${projects.length}</p>
              <p><strong>Number of Clients:</strong> ${clients.length}</p>
              <p><strong>Date Range:</strong> ${dataModule.filteredData[0]?.issue_date} to ${dataModule.filteredData[dataModule.filteredData.length-1]?.issue_date}</p>
            </div>
          </div>
          <hr>
          <h6>Top Projects by Value</h6>
          <ul>
            ${projects.map(p => {
              const projectTotal = dataModule.filteredData
                .filter(d => d.project === p)
                .reduce((sum, d) => sum + d.total_amount, 0);
              return `<li>${p}: ฿${projectTotal.toLocaleString('th-TH')}</li>`;
            }).join('')}
          </ul>
        </div>
      </div>`;
  },
  
  generateDetail() {
    return `
      <div class="card">
        <div class="card-body">
          <h5>Detailed Report</h5>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <tbody>
                ${dataModule.filteredData.map(d => `
                  <tr class="table-primary">
                    <td colspan="2"><strong>PO: ${d.po_number}</strong></td>
                  </tr>
                  <tr>
                    <td width="30%">Date:</td>
                    <td>${new Date(d.issue_date).toLocaleDateString('en-US')}</td>
                  </tr>
                  <tr>
                    <td>Client:</td>
                    <td>${d.client_name}</td>
                  </tr>
                  <tr>
                    <td>Project:</td>
                    <td>${d.project}</td>
                  </tr>
                  <tr>
                    <td>Description:</td>
                    <td>${d.description}</td>
                  </tr>
                  <tr>
                    <td>Amount:</td>
                    <td><strong>฿${d.total_amount.toLocaleString('th-TH')}</strong></td>
                  </tr>
                  <tr>
                    <td>Status:</td>
                    <td><span class="badge bg-${d.status === 'active' ? 'success' : 'secondary'}">${d.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>`;
  },
  
  generateA4() {
    const total = dataModule.filteredData.reduce((sum, d) => sum + d.total_amount, 0);
    return `
      <div class="card" style="width:210mm;min-height:297mm;padding:20mm;margin:auto;background:white">
        <div style="text-align:center;margin-bottom:20px">
          <h2>PORTFOLIO REPORT</h2>
          <p>Generated on ${new Date().toLocaleDateString('en-US')}</p>
        </div>
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>PO Number</th>
              <th>Date</th>
              <th>Client</th>
              <th>Project</th>
              <th>Amount (THB)</th>
            </tr>
          </thead>
          <tbody>
            ${dataModule.filteredData.map(d => `
              <tr>
                <td>${d.po_number}</td>
                <td>${new Date(d.issue_date).toLocaleDateString('en-US')}</td>
                <td>${d.client_name}</td>
                <td>${d.project}</td>
                <td class="text-end">฿${d.total_amount.toLocaleString('th-TH')}</td>
              </tr>`).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end"><strong>TOTAL</strong></td>
              <td class="text-end"><strong>฿${total.toLocaleString('th-TH')}</strong></td>
            </tr>
          </tfoot>
        </table>
        <div class="mt-4" style="border-top:1px solid #ddd;padding-top:20px">
          <p><small>This document is system generated. No signature required.</small></p>
        </div>
      </div>
      <div class="no-print mt-3 text-center">
        <button class="btn btn-primary" onclick="window.print()">Print Report</button>
      </div>`;
  }
};

$(document).ready(() => {
  dataModule.init();
});
</script>
</body>
</html>