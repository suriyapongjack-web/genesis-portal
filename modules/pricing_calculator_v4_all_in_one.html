<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Pricing Calculator v4.0 - All-in-One</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .project-info-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .project-info-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .project-info-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        .version-badge {
            position: absolute;
            top: 25px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .action-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .controls {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
        }
        
        .control-item label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            letter-spacing: 0.5px;
        }
        
        .control-item input,
        .control-item select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .control-item input:focus,
        .control-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .card-title {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        
        .card-value small {
            font-size: 14px;
            color: #6c757d;
            font-weight: normal;
        }
        
        .card-subtitle {
            font-size: 13px;
            color: #667eea;
            margin-top: 5px;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            font-size: 13px;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        th {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .editable {
            background: #e7f1ff;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .editable:hover {
            background: #cfe2ff;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .subtotal-row {
            background: linear-gradient(135deg, #e8f4f8 0%, #d6e9f3 100%);
            font-weight: bold;
        }
        
        .total-row {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .margin-good {
            color: #28a745;
            font-weight: bold;
        }
        
        .margin-ok {
            color: #ffc107;
            font-weight: bold;
        }
        
        .margin-bad {
            color: #dc3545;
            font-weight: bold;
        }
        
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .import-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-drop-zone:hover {
            background: #e8f4f8;
            border-color: #764ba2;
        }
        
        .file-drop-zone.dragover {
            background: #e8f4f8;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        
        .currency-selector {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .currency-selector h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-item label {
            cursor: pointer;
            font-size: 14px;
        }
        
        .manual-input-row {
            display: grid;
            grid-template-columns: 0.5fr 2fr 3fr 1fr 1.5fr 0.5fr;
            gap: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 6px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .manual-input-row input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .manual-input-row input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Advanced Pricing Calculator v4.0</h1>
            <div class="project-info">
                <div class="project-info-item">
                    <span class="project-info-label">Project Name</span>
                    <span class="project-info-value" id="projectName">New Project</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Created Date</span>
                    <span class="project-info-value" id="createdDate">-</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Last Modified</span>
                    <span class="project-info-value" id="modifiedDate">-</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Total Items</span>
                    <span class="project-info-value" id="totalItems">0</span>
                </div>
            </div>
            <div class="version-badge">Version 4.0.0</div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="action-group">
                <button class="btn btn-info" onclick="showImportModal()">
                    üìÇ Import Excel
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    üìä Export Excel
                </button>
                <button class="btn btn-primary" onclick="addManualRow()">
                    ‚ûï Add Row
                </button>
                <button class="btn btn-warning" onclick="clearAll()">
                    üóëÔ∏è Clear All
                </button>
            </div>
            <div class="action-group">
                <button class="btn btn-danger" onclick="resetToDefaults()">
                    üîÑ Reset Defaults
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-item">
                <label>Exchange Rate (THB/USD)</label>
                <input type="number" id="exchangeRate" value="31.5" step="0.01" oninput="recalculateAll()">
            </div>
            <div class="control-item">
                <label>Target Markup %</label>
                <input type="number" id="targetMarkup" value="0" step="0.1" oninput="applyMarkup()">
            </div>
            <div class="control-item">
                <label>Display Mode</label>
                <select id="displayMode" onchange="toggleDisplay()">
                    <option value="both">THB + USD</option>
                    <option value="thb">THB Only</option>
                    <option value="usd">USD Only</option>
                </select>
            </div>
            <div class="control-item">
                <label>Input Currency</label>
                <select id="inputCurrency" onchange="recalculateAll()">
                    <option value="THB">THB (Baht)</option>
                    <option value="USD">USD (Dollar)</option>
                </select>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card">
                <div class="card-title">Total Cost</div>
                <div class="card-value">
                    $<span id="totalCost">0.00</span>
                    <small>USD</small>
                </div>
                <div class="card-subtitle">‡∏ø<span id="totalCostTHB">0</span> THB</div>
            </div>
            <div class="card">
                <div class="card-title">Selling Price</div>
                <div class="card-value">
                    $<span id="totalSelling">0.00</span>
                    <small>USD</small>
                </div>
                <div class="card-subtitle">‡∏ø<span id="totalSellingTHB">0</span> THB</div>
            </div>
            <div class="card">
                <div class="card-title">Total Markup</div>
                <div class="card-value">
                    $<span id="totalMarkupUSD">0.00</span>
                    <small>USD</small>
                </div>
                <div class="card-subtitle"><span id="markupPercent">0.0</span>% Margin</div>
            </div>
            <div class="card">
                <div class="card-title">Grand Total</div>
                <div class="card-value">
                    $<span id="grandTotal">0.00</span>
                    <small>USD</small>
                </div>
                <div class="card-subtitle">‡∏ø<span id="grandTotalTHB">0</span> THB</div>
            </div>
        </div>

        <!-- Manual Input Section -->
        <div id="manualInputSection" style="padding: 0 30px; display: none;">
            <h3 style="margin-bottom: 10px; color: #2c3e50;">Add Items Manually</h3>
            <div id="manualInputContainer"></div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table id="pricingTable">
                <thead>
                    <tr>
                        <th width="3%" class="text-center">#</th>
                        <th width="12%">Part Number</th>
                        <th width="25%">Description</th>
                        <th width="5%" class="text-center">Qty</th>
                        <th width="10%" class="text-right thb-col">Cost/Unit (THB)</th>
                        <th width="10%" class="text-right thb-col">Total Cost (THB)</th>
                        <th width="8%" class="text-center">Markup %</th>
                        <th width="10%" class="text-right thb-col">Sell/Unit (THB)</th>
                        <th width="10%" class="text-right usd-col">Sell/Unit (USD)</th>
                        <th width="10%" class="text-right usd-col">Total (USD)</th>
                        <th width="5%" class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="import-modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÇ Import Excel File</h3>
                <p style="color: #6c757d; font-size: 14px;">
                    Upload your Excel file with columns: Part Number, Description, Qty, Cost/Unit
                </p>
            </div>
            
            <div class="file-drop-zone" id="dropZone">
                <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                <p style="font-size: 16px; margin-bottom: 10px;">
                    Drag & Drop your Excel file here
                </p>
                <p style="font-size: 14px; color: #6c757d;">
                    or <span style="color: #667eea; text-decoration: underline;">browse</span> to upload
                </p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
            </div>
            
            <div class="currency-selector">
                <h4>Select Currency of Cost Data:</h4>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="importTHB" name="importCurrency" value="THB" checked>
                        <label for="importTHB">THB (Thai Baht)</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="importUSD" name="importCurrency" value="USD">
                        <label for="importUSD">USD (US Dollar)</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="importAuto" name="importCurrency" value="AUTO">
                        <label for="importAuto">Auto Detect</label>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-primary" id="importBtn" onclick="processImport()" disabled>
                    Import Data
                </button>
                <button class="btn btn-danger" onclick="closeImportModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
    // ==========================================
    // EMBEDDED JAVASCRIPT - All-in-One Version
    // ==========================================
    
    // Core Pricing Engine
    class PricingEngine {
        constructor(config = {}) {
            this.items = [];
            this.exchangeRate = config.exchangeRate || 31.5;
            this.targetMarkup = config.targetMarkup || 0;
            this.inputCurrency = config.inputCurrency || 'THB';
            this.version = '4.0.0';
            this.projectName = config.projectName || 'New Project';
            this.createdDate = new Date();
            this.modifiedDate = new Date();
        }

        addItem(partNumber, description, qty, cost, currency = null) {
            const effectiveCurrency = currency || this.inputCurrency;
            let costTHB, costUSD;
            
            if (effectiveCurrency === 'THB') {
                costTHB = parseFloat(cost) || 0;
                costUSD = costTHB / this.exchangeRate;
            } else {
                costUSD = parseFloat(cost) || 0;
                costTHB = costUSD * this.exchangeRate;
            }
            
            const item = {
                id: Date.now() + Math.random(),
                partNumber: partNumber || '',
                description: description || '',
                qty: parseInt(qty) || 1,
                costTHB: costTHB,
                costUSD: costUSD,
                originalCurrency: effectiveCurrency
            };
            
            this.items.push(item);
            this.modifiedDate = new Date();
            return item;
        }

        updateItem(id, field, value) {
            const item = this.items.find(i => i.id === id);
            if (item) {
                if (field === 'costTHB') {
                    item.costTHB = parseFloat(value) || 0;
                    item.costUSD = item.costTHB / this.exchangeRate;
                } else if (field === 'costUSD') {
                    item.costUSD = parseFloat(value) || 0;
                    item.costTHB = item.costUSD * this.exchangeRate;
                } else {
                    item[field] = field === 'qty' ? parseInt(value) || 1 : value;
                }
                this.modifiedDate = new Date();
            }
        }

        removeItem(id) {
            this.items = this.items.filter(i => i.id !== id);
            this.modifiedDate = new Date();
        }

        clearItems() {
            this.items = [];
            this.modifiedDate = new Date();
        }

        setExchangeRate(rate) {
            this.exchangeRate = parseFloat(rate) || 31.5;
            this.items.forEach(item => {
                if (item.originalCurrency === 'THB') {
                    item.costUSD = item.costTHB / this.exchangeRate;
                } else {
                    item.costTHB = item.costUSD * this.exchangeRate;
                }
            });
            this.modifiedDate = new Date();
            return this;
        }

        setTargetMarkup(markup) {
            this.targetMarkup = parseFloat(markup) || 0;
            this.modifiedDate = new Date();
            return this;
        }

        calculateItem(item) {
            const sellTHB = item.costTHB * (1 + this.targetMarkup / 100);
            const sellUSD = sellTHB / this.exchangeRate;
            const totalCostTHB = item.costTHB * item.qty;
            const totalCostUSD = item.costUSD * item.qty;
            const totalSellTHB = sellTHB * item.qty;
            const totalSellUSD = sellUSD * item.qty;
            
            const rawMarkup = item.costTHB > 0 ? 
                ((sellTHB - item.costTHB) / item.costTHB * 100) : 0;
            const markup = Math.abs(rawMarkup) < 0.01 ? 0 : rawMarkup;

            return {
                ...item,
                sellTHB,
                sellUSD,
                totalCostTHB,
                totalCostUSD,
                totalSellTHB,
                totalSellUSD,
                markup
            };
        }

        getAllCalculations() {
            return this.items.map(item => this.calculateItem(item));
        }

        getTotals() {
            let totalCostTHB = 0;
            let totalCostUSD = 0;
            let totalSellTHB = 0;
            let totalSellUSD = 0;

            this.items.forEach(item => {
                const calc = this.calculateItem(item);
                totalCostTHB += calc.totalCostTHB;
                totalCostUSD += calc.totalCostUSD;
                totalSellTHB += calc.totalSellTHB;
                totalSellUSD += calc.totalSellUSD;
            });

            const markupUSD = totalSellUSD - totalCostUSD;
            const markupTHB = totalSellTHB - totalCostTHB;
            
            const rawMarkupPercent = totalCostUSD > 0 ? 
                (markupUSD / totalCostUSD * 100) : 0;
            const markupPercent = Math.abs(rawMarkupPercent) < 0.01 ? 0 : rawMarkupPercent;
            const cleanMarkupUSD = Math.abs(markupUSD) < 0.01 ? 0 : markupUSD;

            return {
                totalCostUSD,
                totalCostTHB,
                totalSellUSD,
                totalSellTHB,
                markupUSD: cleanMarkupUSD,
                markupTHB,
                markupPercent,
                exchangeRate: this.exchangeRate,
                targetMarkup: this.targetMarkup,
                itemCount: this.items.length
            };
        }
    }

    // Excel Handler
    class ExcelHandler {
        constructor(engine) {
            this.engine = engine;
        }

        detectCurrency(data) {
            const headers = Object.keys(data[0] || {});
            const hasTHB = headers.some(h => h.toUpperCase().includes('THB'));
            const hasUSD = headers.some(h => h.toUpperCase().includes('USD'));
            
            if (hasTHB && !hasUSD) return 'THB';
            if (hasUSD && !hasTHB) return 'USD';
            
            const values = data.map(row => {
                const cost = parseFloat(row['Cost/Unit'] || row['Cost'] || row['cost'] || 0);
                return cost;
            }).filter(v => v > 0);
            
            const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
            
            return avgValue > 1000 ? 'THB' : 'USD';
        }

        importFromFile(file, currencyOverride = 'AUTO') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        const currency = currencyOverride === 'AUTO' ? 
                            this.detectCurrency(jsonData) : currencyOverride;
                        
                        this.engine.clearItems();
                        
                        let importedCount = 0;
                        jsonData.forEach(row => {
                            const partNumber = 
                                row['Part Number'] || row['part number'] || 
                                row['PART NUMBER'] || row['PN'] || '';
                            const description = 
                                row['Description'] || row['description'] || 
                                row['DESCRIPTION'] || row['DESC'] || '';
                            const qty = 
                                row['Qty'] || row['qty'] || row['QTY'] || 
                                row['Quantity'] || row['quantity'] || 1;
                            const cost = 
                                row['Cost/Unit (THB)'] || row['Cost/Unit (USD)'] ||
                                row['Cost/Unit'] || row['Cost'] || 
                                row['cost'] || row['COST'] || 0;
                            
                            if ((partNumber || description) && parseFloat(cost) > 0) {
                                this.engine.addItem(partNumber, description, qty, cost, currency);
                                importedCount++;
                            }
                        });
                        
                        resolve({
                            success: true,
                            count: importedCount,
                            currency: currency,
                            message: `Successfully imported ${importedCount} items (Currency: ${currency})`
                        });
                    } catch (error) {
                        reject({
                            success: false,
                            message: 'Error reading Excel file: ' + error.message
                        });
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        exportToExcel(filename = null) {
            const projectName = this.engine.projectName;
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            
            const fileName = filename || 
                `${projectName.replace(/\s+/g, '_')}_${dateStr}_${timeStr}.xlsx`;
            
            const data = [
                ['Project Information'],
                ['Project Name', projectName],
                ['Version', this.engine.version],
                ['Export Date', now.toLocaleString()],
                ['Exchange Rate', this.engine.exchangeRate + ' THB/USD'],
                ['Target Markup', this.engine.targetMarkup + '%'],
                [],
                ['Item Details'],
                [
                    '#', 'Part Number', 'Description', 'Qty',
                    'Cost/Unit (THB)', 'Cost/Unit (USD)', 
                    'Total Cost (THB)', 'Total Cost (USD)',
                    'Markup %', 'Sell/Unit (THB)', 'Sell/Unit (USD)',
                    'Total Sell (THB)', 'Total Sell (USD)'
                ]
            ];
            
            const calculations = this.engine.getAllCalculations();
            calculations.forEach((calc, index) => {
                data.push([
                    index + 1,
                    calc.partNumber,
                    calc.description,
                    calc.qty,
                    calc.costTHB.toFixed(2),
                    calc.costUSD.toFixed(2),
                    calc.totalCostTHB.toFixed(2),
                    calc.totalCostUSD.toFixed(2),
                    calc.markup.toFixed(1),
                    calc.sellTHB.toFixed(2),
                    calc.sellUSD.toFixed(2),
                    calc.totalSellTHB.toFixed(2),
                    calc.totalSellUSD.toFixed(2)
                ]);
            });
            
            const totals = this.engine.getTotals();
            data.push([]);
            data.push(['Summary']);
            data.push(['Total Items', totals.itemCount]);
            data.push(['Total Cost (THB)', totals.totalCostTHB.toFixed(2)]);
            data.push(['Total Cost (USD)', totals.totalCostUSD.toFixed(2)]);
            data.push(['Total Selling (THB)', totals.totalSellTHB.toFixed(2)]);
            data.push(['Total Selling (USD)', totals.totalSellUSD.toFixed(2)]);
            data.push(['Total Markup (THB)', totals.markupTHB.toFixed(2)]);
            data.push(['Total Markup (USD)', totals.markupUSD.toFixed(2)]);
            data.push(['Markup Percentage', totals.markupPercent.toFixed(1) + '%']);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pricing Data');
            
            XLSX.writeFile(wb, fileName);
            
            return fileName;
        }
    }

    // UI Manager
    class UIManager {
        constructor(engine, excelHandler) {
            this.engine = engine;
            this.excelHandler = excelHandler;
            this.selectedFile = null;
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.updateTimestamps();
            this.loadSampleData();
            this.updateAll();
        }

        setupEventListeners() {
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect({ target: { files: files } });
                    }
                });
            }
        }

        updateTimestamps() {
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            
            const createdElem = document.getElementById('createdDate');
            if (createdElem && createdElem.textContent === '-') {
                createdElem.textContent = dateStr;
            }
            
            const modifiedElem = document.getElementById('modifiedDate');
            if (modifiedElem) {
                modifiedElem.textContent = dateStr;
            }
        }

        updateAll() {
            this.updateTable();
            this.updateSummary();
            this.updateItemCount();
        }

        updateTable() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const calculations = this.engine.getAllCalculations();
            
            calculations.forEach((calc, index) => {
                const row = tbody.insertRow();
                const markupClass = calc.markup >= 25 ? 'margin-good' :
                                   calc.markup >= 15 ? 'margin-ok' : 'margin-bad';
                
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="editable" onclick="ui.editCell(this, ${calc.id}, 'partNumber')">${calc.partNumber}</td>
                    <td class="editable" onclick="ui.editCell(this, ${calc.id}, 'description')">${calc.description}</td>
                    <td class="text-center editable" onclick="ui.editCell(this, ${calc.id}, 'qty')">${calc.qty}</td>
                    <td class="text-right thb-col editable" onclick="ui.editCell(this, ${calc.id}, 'costTHB')">${calc.costTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="text-right thb-col">${calc.totalCostTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="text-center ${markupClass}">${calc.markup.toFixed(1)}%</td>
                    <td class="text-right thb-col">${calc.sellTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="text-right usd-col">${calc.sellUSD.toFixed(2)}</td>
                    <td class="text-right usd-col">${calc.totalSellUSD.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="delete-btn" onclick="ui.removeItem(${calc.id})">üóëÔ∏è</button>
                    </td>
                `;
            });
            
            this.addTotalRows(tbody);
        }

        addTotalRows(tbody) {
            const totals = this.engine.getTotals();
            
            const subtotalRow = tbody.insertRow();
            subtotalRow.className = 'subtotal-row';
            subtotalRow.innerHTML = `
                <td colspan="5" style="text-align: right;"><strong>SUBTOTAL</strong></td>
                <td class="text-right thb-col"><strong>${totals.totalCostTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                <td class="text-center"><strong>${totals.markupPercent.toFixed(1)}%</strong></td>
                <td class="text-right thb-col"><strong>${totals.totalSellTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                <td class="text-right usd-col"><strong>$${totals.totalSellUSD.toFixed(2)}</strong></td>
                <td></td>
                <td></td>
            `;
            
            const totalRow = tbody.insertRow();
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td colspan="5" style="text-align: right;"><strong>GRAND TOTAL</strong></td>
                <td class="text-right thb-col"><strong>${totals.totalCostTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                <td></td>
                <td class="text-right thb-col"><strong>${totals.totalSellTHB.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                <td></td>
                <td class="text-right usd-col"><strong>$${totals.totalSellUSD.toFixed(2)}</strong></td>
                <td></td>
            `;
        }

        updateSummary() {
            const totals = this.engine.getTotals();
            
            this.setElementText('totalCost', totals.totalCostUSD.toFixed(2));
            this.setElementText('totalCostTHB', Math.round(totals.totalCostTHB).toLocaleString());
            this.setElementText('totalSelling', totals.totalSellUSD.toFixed(2));
            this.setElementText('totalSellingTHB', Math.round(totals.totalSellTHB).toLocaleString());
            this.setElementText('totalMarkupUSD', totals.markupUSD.toFixed(2));
            this.setElementText('markupPercent', totals.markupPercent.toFixed(1));
            this.setElementText('grandTotal', totals.totalSellUSD.toFixed(2));
            this.setElementText('grandTotalTHB', Math.round(totals.totalSellTHB).toLocaleString());
        }

        updateItemCount() {
            const totals = this.engine.getTotals();
            this.setElementText('totalItems', totals.itemCount);
        }

        setElementText(id, text) {
            const element = document.getElementById(id);
            if (element) element.textContent = text;
        }

        editCell(cell, itemId, field) {
            const currentValue = this.engine.items.find(i => i.id === itemId)[field];
            const input = document.createElement('input');
            input.type = field === 'qty' ? 'number' : 'text';
            input.value = currentValue;
            input.style.width = '100%';
            input.style.padding = '5px';
            
            input.onblur = () => {
                this.engine.updateItem(itemId, field, input.value);
                this.updateAll();
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        removeItem(id) {
            if (confirm('Are you sure you want to remove this item?')) {
                this.engine.removeItem(id);
                this.updateAll();
                this.updateTimestamps();
            }
        }

        loadSampleData() {
            // Add some sample data
            this.engine.addItem('SAMPLE-001', 'Sample Product 1', 10, 1000, 'THB');
            this.engine.addItem('SAMPLE-002', 'Sample Product 2', 5, 50, 'USD');
            this.engine.addItem('SAMPLE-003', 'Sample Product 3', 3, 2500, 'THB');
        }
    }

    // Global instances
    let engine, excelHandler, ui;

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
        engine = new PricingEngine();
        excelHandler = new ExcelHandler(engine);
        ui = new UIManager(engine, excelHandler);
    });

    // Global functions for HTML events
    function recalculateAll() {
        const rate = document.getElementById('exchangeRate').value;
        engine.setExchangeRate(rate);
        ui.updateAll();
    }

    function applyMarkup() {
        const markup = document.getElementById('targetMarkup').value;
        engine.setTargetMarkup(markup);
        ui.updateAll();
    }

    function toggleDisplay() {
        const mode = document.getElementById('displayMode').value;
        const thbCols = document.querySelectorAll('.thb-col');
        const usdCols = document.querySelectorAll('.usd-col');
        
        if (mode === 'thb') {
            usdCols.forEach(col => col.style.display = 'none');
            thbCols.forEach(col => col.style.display = '');
        } else if (mode === 'usd') {
            thbCols.forEach(col => col.style.display = 'none');
            usdCols.forEach(col => col.style.display = '');
        } else {
            thbCols.forEach(col => col.style.display = '');
            usdCols.forEach(col => col.style.display = '');
        }
    }

    function showImportModal() {
        document.getElementById('importModal').classList.add('show');
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.remove('show');
        document.getElementById('fileInput').value = '';
        document.getElementById('importBtn').disabled = true;
        ui.selectedFile = null;
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            ui.selectedFile = file;
            document.getElementById('importBtn').disabled = false;
            
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                <p style="font-size: 16px; margin-bottom: 10px; color: #28a745;">
                    File Selected: ${file.name}
                </p>
                <p style="font-size: 14px; color: #6c757d;">
                    Size: ${(file.size / 1024).toFixed(2)} KB
                </p>
            `;
        }
    }

    function processImport() {
        if (!ui.selectedFile) return;
        
        const currencyRadios = document.getElementsByName('importCurrency');
        let selectedCurrency = 'THB';
        for (const radio of currencyRadios) {
            if (radio.checked) {
                selectedCurrency = radio.value;
                break;
            }
        }
        
        excelHandler.importFromFile(ui.selectedFile, selectedCurrency)
            .then(result => {
                alert(result.message);
                closeImportModal();
                ui.updateAll();
                ui.updateTimestamps();
            })
            .catch(error => {
                alert('Import Error: ' + error.message);
            });
    }

    function exportToExcel() {
        const filename = excelHandler.exportToExcel();
        alert(`Exported: ${filename}`);
    }

    function addManualRow() {
        const manualSection = document.getElementById('manualInputSection');
        const container = document.getElementById('manualInputContainer');
        
        manualSection.style.display = 'block';
        
        const rowId = 'manual_' + Date.now();
        const rowDiv = document.createElement('div');
        rowDiv.className = 'manual-input-row';
        rowDiv.id = rowId;
        rowDiv.innerHTML = `
            <span style="text-align: center;">${container.children.length + 1}</span>
            <input type="text" placeholder="Part Number" id="${rowId}_part">
            <input type="text" placeholder="Description" id="${rowId}_desc">
            <input type="number" placeholder="Qty" value="1" min="1" id="${rowId}_qty">
            <input type="number" placeholder="Cost/Unit" step="0.01" id="${rowId}_cost">
            <button class="btn btn-primary btn-sm" onclick="addItemFromManual('${rowId}')">Add</button>
        `;
        
        container.appendChild(rowDiv);
    }

    function addItemFromManual(rowId) {
        const partNumber = document.getElementById(`${rowId}_part`).value;
        const description = document.getElementById(`${rowId}_desc`).value;
        const qty = document.getElementById(`${rowId}_qty`).value;
        const cost = document.getElementById(`${rowId}_cost`).value;
        const currency = document.getElementById('inputCurrency').value;
        
        if (!partNumber && !description) {
            alert('Please enter at least a part number or description');
            return;
        }
        
        if (!cost || parseFloat(cost) <= 0) {
            alert('Please enter a valid cost');
            return;
        }
        
        engine.addItem(partNumber, description, qty, cost, currency);
        ui.updateAll();
        ui.updateTimestamps();
        
        document.getElementById(rowId).remove();
        
        const container = document.getElementById('manualInputContainer');
        if (container.children.length === 0) {
            document.getElementById('manualInputSection').style.display = 'none';
        }
    }

    function clearAll() {
        if (confirm('Are you sure you want to clear all items?')) {
            engine.clearItems();
            ui.updateAll();
            ui.updateTimestamps();
            document.getElementById('manualInputContainer').innerHTML = '';
            document.getElementById('manualInputSection').style.display = 'none';
        }
    }

    function resetToDefaults() {
        if (confirm('Reset exchange rate and markup to default values?')) {
            document.getElementById('exchangeRate').value = 31.5;
            document.getElementById('targetMarkup').value = 0;
            engine.setExchangeRate(31.5);
            engine.setTargetMarkup(0);
            ui.updateAll();
        }
    }
    </script>
</body>
</html>
